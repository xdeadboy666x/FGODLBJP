name: Cobro Auto Log

on:
  workflow_dispatch:
    inputs:
      vehiculo:
        description: "Vehicle name"
        required: true
      entry_time:
        description: "Entry time"
        required: true
      exit_time:
        description: "Exit time"
        required: true

jobs:
  cobro:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      TZ: America/Mexico_City

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run cobro.py
        run: |
          python3 cobro.py ${{ github.event.inputs.vehiculo }} ${{ github.event.inputs.entry_time }} ${{ github.event.inputs.exit_time }}

      - name: Check if it's 18:45 in Mexico City
        id: check_time
        run: |
          now=$(date +'%H:%M')
          if [ "$now" = "18:45" ]; then
            echo "run_total=true" >> $GITHUB_ENV
          else
            echo "run_total=false" >> $GITHUB_ENV
          fi

      - name: Post total log to Discord
        if: env.run_total == 'true'
        run: |
          total_log=$(python3 $HOME/cobro.py --print-total)
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"**Daily total:**\n$total_log\"}" \
               "$DISCORD_WEBHOOK"